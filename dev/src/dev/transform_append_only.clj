(ns dev.transform-append-only
  (:require
   [clojure.pprint :refer [print-table]]
   [tick.core :as t]
   [tablecloth.api :as tc]
   [missionary.core :as m]
   [ta.db.bars.protocol :as b]
   [dev.env :refer [bar-engine]]
   [quanta.bar.preload :refer [import-bars import-bars-one]]
   [quanta.bar.transform.append-only :refer [missing-bars-window]]
   [quanta.calendar.core :as c]))

;;
;; Import data
;;

;; import bybit :m
(m/? (import-bars
      bar-engine
      {:asset "BTCUSDT"
       :calendar [:crypto :m]
       :import :bybit-parallel
       :to :nippy
       :window {:start (t/instant "2024-08-01T00:01:00Z")
                :end (t/instant "2024-09-09T00:00:00Z")}
       :label "import bybit :m"}))

(m/? (import-bars
      bar-engine
      {:asset "BTCUSDT"
       :calendar [:crypto :d]
       :import :bybit-parallel
       :to :nippy
       :window {:start (t/instant "2024-08-01T23:59:59.999999999Z")
                :end (t/instant "2024-09-08T23:59:59.999999999Z")}
       :label "import bybit :d"}))

; data available:
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {}))
;=> _unnamed [39 7]:
;
;|                       :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|-----------------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-08-01T23:59:59.999999Z | 64631.66 | 65664.17 | 62276.07 | 65359.52 | 26649.072201 | BTCUSDT |
;| 2024-08-02T23:59:59.999999Z | 65359.52 | 65604.69 | 61220.51 | 61492.70 | 30995.032601 | BTCUSDT |
;| 2024-08-03T23:59:59.999999Z | 61492.70 | 62195.44 | 59845.00 | 60706.71 | 24048.623913 | BTCUSDT |
;| 2024-08-04T23:59:59.999999Z | 60706.71 | 61117.99 | 57141.00 | 58165.87 | 22629.787445 | BTCUSDT |
;| 2024-08-05T23:59:59.999999Z | 58165.87 | 58308.01 | 48974.00 | 54024.47 | 83370.985286 | BTCUSDT |
;| 2024-08-06T23:59:59.999999Z | 54024.47 | 57078.28 | 53946.16 | 56019.93 | 29868.423264 | BTCUSDT |
;| 2024-08-07T23:59:59.999999Z | 56019.93 | 57753.00 | 54548.70 | 55143.12 | 24187.586582 | BTCUSDT |
;| 2024-08-08T23:59:59.999999Z | 55143.12 | 62745.45 | 54736.64 | 61686.97 | 26074.519089 | BTCUSDT |
;| 2024-08-09T23:59:59.999999Z | 61686.97 | 61757.07 | 59520.53 | 60845.02 | 22877.550585 | BTCUSDT |
;| 2024-08-10T23:59:59.999999Z | 60845.02 | 61484.99 | 60240.58 | 60923.71 | 22990.614685 | BTCUSDT |
;|                         ... |      ... |      ... |      ... |      ... |          ... |     ... |
;| 2024-08-29T23:59:59.999999Z | 59044.69 | 61175.07 | 58703.08 | 59348.57 | 18827.563337 | BTCUSDT |
;| 2024-08-30T23:59:59.999999Z | 59348.57 | 59944.16 | 57700.00 | 59130.23 | 19456.016647 | BTCUSDT |
;| 2024-08-31T23:59:59.999999Z | 59130.23 | 59463.00 | 58736.42 | 58972.48 |  7176.997611 | BTCUSDT |
;| 2024-09-01T23:59:59.999999Z | 58972.48 | 59080.67 | 57162.76 | 57293.29 | 16960.761333 | BTCUSDT |
;| 2024-09-02T23:59:59.999999Z | 57293.29 | 59432.74 | 57124.21 | 59142.75 | 23098.259720 | BTCUSDT |
;| 2024-09-03T23:59:59.999999Z | 59142.75 | 59825.00 | 57401.01 | 57481.78 | 20902.434172 | BTCUSDT |
;| 2024-09-04T23:59:59.999999Z | 57481.78 | 58526.02 | 55566.05 | 57972.69 | 30443.293677 | BTCUSDT |
;| 2024-09-05T23:59:59.999999Z | 57972.69 | 58333.08 | 55632.01 | 56177.67 | 28363.931568 | BTCUSDT |
;| 2024-09-06T23:59:59.999999Z | 56177.67 | 57018.51 | 52535.50 | 53961.62 | 33299.004330 | BTCUSDT |
;| 2024-09-07T23:59:59.999999Z | 53961.62 | 54851.34 | 53750.02 | 54164.51 | 22779.134421 | BTCUSDT |
;| 2024-09-08T23:59:59.999999Z | 54164.51 | 55324.49 | 53628.06 | 54877.92 | 14830.880938 | BTCUSDT |

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :m]
              :bardb :nippy}
             {}))

;=> _unnamed [56160 7]:
;
;|                       :date |    :open |    :high |     :low |   :close |   :volume |  :asset |
;|-----------------------------|---------:|---------:|---------:|---------:|----------:|---------|
;|        2024-08-01T00:01:00Z | 64631.66 | 64681.04 | 64602.43 | 64634.26 | 22.534596 | BTCUSDT |
;|        2024-08-01T00:02:00Z | 64634.26 | 64691.09 | 64620.67 | 64671.30 | 13.958742 | BTCUSDT |
;|        2024-08-01T00:03:00Z | 64671.30 | 64703.44 | 64622.29 | 64623.85 | 13.145399 | BTCUSDT |
;|        2024-08-01T00:04:00Z | 64623.85 | 64700.55 | 64623.85 | 64687.91 | 16.006270 | BTCUSDT |
;|        2024-08-01T00:05:00Z | 64687.91 | 64710.94 | 64674.54 | 64679.51 | 11.166516 | BTCUSDT |
;|        2024-08-01T00:06:00Z | 64679.51 | 64744.75 | 64679.51 | 64744.75 |  8.044719 | BTCUSDT |
;|        2024-08-01T00:07:00Z | 64744.75 | 64780.50 | 64729.61 | 64780.49 |  8.742001 | BTCUSDT |
;|        2024-08-01T00:08:00Z | 64780.49 | 64794.80 | 64727.72 | 64735.00 | 17.130190 | BTCUSDT |
;|        2024-08-01T00:09:00Z | 64735.00 | 64761.00 | 64675.85 | 64723.95 | 16.429661 | BTCUSDT |
;|        2024-08-01T00:10:00Z | 64723.95 | 64788.93 | 64720.41 | 64786.35 | 13.307908 | BTCUSDT |
;|                         ... |      ... |      ... |      ... |      ... |       ... |     ... |
;|        2024-09-08T23:50:00Z | 54968.04 | 54981.44 | 54937.83 | 54966.25 | 12.344033 | BTCUSDT |
;|        2024-09-08T23:51:00Z | 54966.25 | 54968.28 | 54939.09 | 54940.48 |  7.010051 | BTCUSDT |
;|        2024-09-08T23:52:00Z | 54940.48 | 54940.49 | 54887.95 | 54887.95 |  9.858889 | BTCUSDT |
;|        2024-09-08T23:53:00Z | 54887.95 | 54887.95 | 54792.70 | 54808.59 | 21.034793 | BTCUSDT |
;|        2024-09-08T23:54:00Z | 54808.59 | 54808.59 | 54770.93 | 54800.64 | 10.463140 | BTCUSDT |
;|        2024-09-08T23:55:00Z | 54800.64 | 54837.33 | 54788.88 | 54835.98 | 13.970130 | BTCUSDT |
;|        2024-09-08T23:56:00Z | 54835.98 | 54859.06 | 54830.61 | 54834.70 |  5.499155 | BTCUSDT |
;|        2024-09-08T23:57:00Z | 54834.70 | 54834.70 | 54778.43 | 54778.43 | 13.347810 | BTCUSDT |
;|        2024-09-08T23:58:00Z | 54778.43 | 54832.04 | 54778.43 | 54830.40 |  7.733071 | BTCUSDT |
;|        2024-09-08T23:59:00Z | 54830.40 | 54868.94 | 54828.95 | 54868.94 |  7.474791 | BTCUSDT |
;| 2024-09-08T23:59:59.999999Z | 54868.94 | 54877.92 | 54844.58 | 54877.92 |  8.666593 | BTCUSDT |

; full month available
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {:start (t/instant "2024-08-01T00:00:00Z")
              :end (t/instant "2024-09-01T00:00:00Z")}))

; month with missing data
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {:start (t/instant "2024-09-01T00:00:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :m]
              :bardb :nippy}
             {:start (t/instant "2024-09-01T00:00:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))

; compress
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :h]
              :bardb :nippy
              :to :nippy
              :transform :compress}
             {:start (t/instant "2024-09-01T00:01:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))

;|                :date |    :open |    :high |     :low |   :close |     :volume | :count |
;|----------------------|---------:|---------:|---------:|---------:|------------:|-------:|
;| 2024-09-01T01:00:00Z | 58972.48 | 59080.67 | 58900.39 | 58937.19 |  423.351183 |     60 |
;| 2024-09-01T02:00:00Z | 58937.19 | 58961.49 | 58828.60 | 58830.78 |  526.494885 |     60 |
;| 2024-09-01T03:00:00Z | 58830.78 | 58874.48 | 58272.43 | 58544.37 | 1100.334691 |     60 |
;| 2024-09-01T04:00:00Z | 58544.37 | 58676.19 | 58405.11 | 58532.57 |  558.784013 |     60 |
;| 2024-09-01T05:00:00Z | 58532.57 | 58606.32 | 58362.62 | 58440.95 |  523.211722 |     60 |
;| 2024-09-01T06:00:00Z | 58440.95 | 58471.89 | 57766.92 | 57990.29 | 1244.488976 |     60 |
;| 2024-09-01T07:00:00Z | 57990.29 | 58303.88 | 57952.60 | 58197.94 |  662.237077 |     60 |
;| 2024-09-01T08:00:00Z | 58197.94 | 58503.07 | 58130.12 | 58486.20 |  803.564506 |     60 |
;| 2024-09-01T09:00:00Z | 58486.20 | 58513.10 | 58201.40 | 58244.93 |  492.750693 |     60 |
;| 2024-09-01T10:00:00Z | 58244.93 | 58405.50 | 58150.01 | 58205.00 |  558.399776 |     60 |
;|                  ... |      ... |      ... |      ... |      ... |         ... |    ... |
;| 2024-09-08T14:00:00Z | 54203.80 | 54406.11 | 54072.02 | 54395.07 |  632.267188 |     60 |
;| 2024-09-08T15:00:00Z | 54395.07 | 54446.03 | 54045.90 | 54141.28 |  790.841862 |     60 |
;| 2024-09-08T16:00:00Z | 54141.28 | 54196.52 | 53649.59 | 53693.57 | 1241.974240 |     60 |
;| 2024-09-08T17:00:00Z | 53693.57 | 54031.35 | 53628.06 | 53913.11 |  664.116857 |     60 |
;| 2024-09-08T18:00:00Z | 53913.11 | 54524.60 | 53902.01 | 54503.86 |  745.223174 |     60 |
;| 2024-09-08T19:00:00Z | 54503.86 | 54537.90 | 54273.70 | 54417.72 |  496.323146 |     60 |
;| 2024-09-08T20:00:00Z | 54417.72 | 54485.29 | 54312.89 | 54338.54 |  355.174233 |     60 |
;| 2024-09-08T21:00:00Z | 54338.54 | 54391.51 | 54187.02 | 54385.64 |  459.139725 |     60 |
;| 2024-09-08T22:00:00Z | 54385.64 | 54636.29 | 54325.00 | 54463.88 |  487.145795 |     60 |
;| 2024-09-08T23:00:00Z | 54463.88 | 55324.49 | 54365.12 | 54535.04 | 1505.990069 |     60 |
;| 2024-09-09T00:00:00Z | 54535.04 | 54981.80 | 54448.48 | 54877.92 |  654.758483 |     60 |

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy
              :transform :append-only}
             {:start (t/instant "2024-09-01T00:00:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :m]
              :bardb :nippy
               ;:to :nippy
               ;:transform :compress
              }
             {:start (t/instant "2024-09-01T00:01:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))

;; Reason: Instant truncation
(c/current-close [:crypto :h] (t/in (t/instant "2024-09-08T23:59:59.999999Z") "UTC"))

(c/current-close [:crypto :h] (t/in (t/instant "2024-09-08T23:59:59.999999999Z") "UTC"))

;; append-only
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy
              :to :nippy
              :import :bybit-parallel
              :transform :append-only}
             {:start (t/instant "2024-08-25T00:00:00Z")
              :end (t/instant "2024-09-15T00:00:00Z")}))

;|                :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-08-25T00:00:00Z | 64046.30 | 64500.00 | 63543.28 | 64153.50 | 19546.945175 | BTCUSDT |
;| 2024-08-26T00:00:00Z | 64153.50 | 65032.12 | 63780.00 | 64218.10 | 18111.952814 | BTCUSDT |
;| 2024-08-27T00:00:00Z | 64218.10 | 64479.22 | 62796.41 | 62834.75 | 26594.582272 | BTCUSDT |
;| 2024-08-28T00:00:00Z | 62834.75 | 63213.07 | 57955.58 | 59411.08 | 33807.337927 | BTCUSDT |
;| 2024-08-29T00:00:00Z | 59411.08 | 60257.77 | 57801.54 | 59044.69 | 23996.944745 | BTCUSDT |
;| 2024-08-30T00:00:00Z | 59044.69 | 61175.07 | 58703.08 | 59348.57 | 18827.563337 | BTCUSDT |
;| 2024-08-31T00:00:00Z | 59348.57 | 59944.16 | 57700.00 | 59130.23 | 19456.016647 | BTCUSDT |
;| 2024-09-01T00:00:00Z | 59130.23 | 59463.00 | 58736.42 | 58972.48 |  7176.997611 | BTCUSDT |
;| 2024-09-02T00:00:00Z | 58972.48 | 59080.67 | 57162.76 | 57293.29 | 16960.761333 | BTCUSDT |
;| 2024-09-03T00:00:00Z | 57293.29 | 59432.74 | 57124.21 | 59142.75 | 23098.259720 | BTCUSDT |
;| 2024-09-04T00:00:00Z | 59142.75 | 59825.00 | 57401.01 | 57481.78 | 20902.434172 | BTCUSDT |
;| 2024-09-05T00:00:00Z | 57481.78 | 58526.02 | 55566.05 | 57972.69 | 30443.293677 | BTCUSDT |
;| 2024-09-06T00:00:00Z | 57972.69 | 58333.08 | 55632.01 | 56177.67 | 28363.931568 | BTCUSDT |
;| 2024-09-07T00:00:00Z | 56177.67 | 57018.51 | 52535.50 | 53961.62 | 33299.004330 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 53961.62 | 54851.34 | 53750.02 | 54164.51 | 22779.134421 | BTCUSDT |
;| 2024-09-09T00:00:00Z | 54164.51 | 55324.49 | 53628.06 | 54877.92 | 14830.880938 | BTCUSDT |
;| 2024-09-10T00:00:00Z | 54877.92 | 58130.24 | 54591.47 | 57039.58 | 21486.315072 | BTCUSDT |

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :h]
              :bardb :nippy
              :to :nippy
              :import :bybit-parallel
              :transform :append-only}
             {:start (t/instant "2024-09-05T00:00:00Z")
              :end (t/instant "2024-09-12T00:00:00Z")}))

;|                :date |    :open |    :high |     :low |   :close |     :volume | :count |
;|----------------------|---------:|---------:|---------:|---------:|------------:|-------:|
;| 2024-09-05T00:00:00Z | 57972.69 | 58333.08 | 57953.52 | 58010.61 | 1045.269190 |     59 |
;| 2024-09-05T01:00:00Z | 58010.61 | 58250.67 | 57952.61 | 58026.26 |  944.724681 |     60 |
;| 2024-09-05T02:00:00Z | 58026.26 | 58068.69 | 57641.42 | 57663.93 |  967.751279 |     60 |
;| 2024-09-05T03:00:00Z | 57663.93 | 57696.47 | 56912.01 | 57095.83 | 1600.801392 |     60 |
;| 2024-09-05T04:00:00Z | 57095.83 | 57292.15 | 57069.10 | 57211.79 |  961.542546 |     60 |
;| 2024-09-05T05:00:00Z | 57211.79 | 57264.09 | 57025.36 | 57194.11 | 1047.564021 |     60 |
;| 2024-09-05T06:00:00Z | 57194.11 | 57229.99 | 56537.77 | 56923.08 | 1380.256089 |     60 |
;| 2024-09-05T07:00:00Z | 56923.08 | 57246.32 | 56827.60 | 57172.46 | 1116.333349 |     60 |
;| 2024-09-05T08:00:00Z | 57172.46 | 57233.44 | 56950.73 | 57005.45 | 1007.701893 |     60 |
;| 2024-09-05T09:00:00Z | 57005.45 | 57020.21 | 56621.84 | 56793.40 | 1373.553309 |     60 |
;|                  ... |      ... |      ... |      ... |      ... |         ... |    ... |
;| 2024-09-11T14:00:00Z | 55813.94 | 56029.82 | 55555.00 | 55861.10 | 1463.463031 |     60 |
;| 2024-09-11T15:00:00Z | 55861.10 | 57018.37 | 55841.02 | 56714.70 | 1318.622584 |     60 |
;| 2024-09-11T16:00:00Z | 56714.70 | 57536.09 | 56649.50 | 57262.84 | 1132.917165 |     60 |
;| 2024-09-11T17:00:00Z | 57262.84 | 57883.39 | 57250.95 | 57675.63 | 1026.816168 |     60 |
;| 2024-09-11T18:00:00Z | 57675.63 | 57991.00 | 57380.00 | 57469.96 | 1209.407065 |     60 |
;| 2024-09-11T19:00:00Z | 57469.96 | 57782.85 | 57324.32 | 57643.48 |  782.175519 |     60 |
;| 2024-09-11T20:00:00Z | 57643.48 | 57682.39 | 57433.07 | 57488.07 |  670.524631 |     60 |
;| 2024-09-11T21:00:00Z | 57488.07 | 57559.54 | 57250.01 | 57310.66 |  457.187678 |     60 |
;| 2024-09-11T22:00:00Z | 57310.66 | 57454.21 | 57208.66 | 57442.87 |  734.179146 |     60 |
;| 2024-09-11T23:00:00Z | 57442.87 | 57516.64 | 57317.95 | 57330.53 |  684.984525 |     60 |
;| 2024-09-12T00:00:00Z | 57330.53 | 57340.85 | 57303.25 | 57334.15 |   11.408682 |      1 |

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :h]
              :bardb :nippy
               ;:to :nippy
               ;:import :bybit-parallel
              :transform :compress}
             {:start (t/instant "2024-08-25T00:01:00Z")
              :end (t/instant "2024-08-25T02:00:01Z")}))

;; get all data
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {}))

;(m/? (import-bars
;       bar-engine
;       {:asset "BTCUSDT"
;        :calendar [:crypto :d]
;        :bardb :nippy
;        :transform :append-only
;        :import :bybit-parallel
;        :to :nippy
;        :window {:start (t/instant "2024-08-31T23:59:59.999999999Z")
;                 :end (t/instant "2024-09-11T23:59:59.999999999Z")}
;        :label "import bybit :d"}))

;; missing-bars-window
(let [cal [:crypto :d]
      ds (m/?
          (b/get-bars bar-engine
                      {:asset "BTCUSDT"
                       :calendar  [:crypto :d]
                       :bardb :nippy}
                      {:start (t/instant "2024-09-01T00:00:00Z")
                       :end (t/instant "2024-09-10T00:00:00Z")}))]
  (missing-bars-window ds
                       cal
                       {:start (t/instant "2024-08-31T23:59:59.999999999Z")
                        :end (t/instant "2024-09-11T23:59:59.999999999Z")}))

