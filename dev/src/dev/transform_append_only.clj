(ns dev.transform-append-only
  (:require
   [clojure.pprint :refer [print-table]]
   [tick.core :as t]
   [tablecloth.api :as tc]
   [missionary.core :as m]
   [ta.db.bars.protocol :as b]
   [dev.env :refer [bar-engine]]
   [quanta.bar.preload :refer [import-bars]]
   [quanta.bar.transform.append-only :refer [missing-bars-window aligned-window compress-bars]]
   [quanta.bar.transform.helper :refer [load-stored-bars]]
   [quanta.calendar.core :as c]
   [ta.db.bars.nippy :as nippy])
  (:import (java.io FileNotFoundException)))

;;
;; Import data
;;

;; import bybit :m
(m/? (import-bars
      bar-engine
      {:asset "BTCUSDT"
       :calendar [:crypto :m]
       :import :bybit-parallel
       :to :nippy
       :window {:start (t/instant "2024-08-01T00:01:00Z")
                :end (t/instant "2024-09-08T00:00:00Z")}
       :label "import bybit :m"}))

(m/? (import-bars
      bar-engine
      {:asset "BTCUSDT"
       :calendar [:crypto :d]
       :import :bybit-parallel
       :to :nippy
       :window {:start (t/instant "2024-08-01T00:01:00Z")
                :end (t/instant "2024-09-08T00:00:00Z")}
       :label "import bybit :d"}))

; data available:
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {}))
;=> _unnamed [38 7]:
;
;|                :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-08-02T00:00:00Z | 64631.66 | 65664.17 | 62276.07 | 65359.52 | 26649.072201 | BTCUSDT |
;| 2024-08-03T00:00:00Z | 65359.52 | 65604.69 | 61220.51 | 61492.70 | 30995.032601 | BTCUSDT |
;| 2024-08-04T00:00:00Z | 61492.70 | 62195.44 | 59845.00 | 60706.71 | 24048.623913 | BTCUSDT |
;| 2024-08-05T00:00:00Z | 60706.71 | 61117.99 | 57141.00 | 58165.87 | 22629.787445 | BTCUSDT |
;| 2024-08-06T00:00:00Z | 58165.87 | 58308.01 | 48974.00 | 54024.47 | 83370.985286 | BTCUSDT |
;| 2024-08-07T00:00:00Z | 54024.47 | 57078.28 | 53946.16 | 56019.93 | 29868.423264 | BTCUSDT |
;| 2024-08-08T00:00:00Z | 56019.93 | 57753.00 | 54548.70 | 55143.12 | 24187.586582 | BTCUSDT |
;| 2024-08-09T00:00:00Z | 55143.12 | 62745.45 | 54736.64 | 61686.97 | 26074.519089 | BTCUSDT |
;| 2024-08-10T00:00:00Z | 61686.97 | 61757.07 | 59520.53 | 60845.02 | 22877.550585 | BTCUSDT |
;| 2024-08-11T00:00:00Z | 60845.02 | 61484.99 | 60240.58 | 60923.71 | 22990.614685 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |          ... |     ... |
;| 2024-08-29T00:00:00Z | 59411.08 | 60257.77 | 57801.54 | 59044.69 | 23996.944745 | BTCUSDT |
;| 2024-08-30T00:00:00Z | 59044.69 | 61175.07 | 58703.08 | 59348.57 | 18827.563337 | BTCUSDT |
;| 2024-08-31T00:00:00Z | 59348.57 | 59944.16 | 57700.00 | 59130.23 | 19456.016647 | BTCUSDT |
;| 2024-09-01T00:00:00Z | 59130.23 | 59463.00 | 58736.42 | 58972.48 |  7176.997611 | BTCUSDT |
;| 2024-09-02T00:00:00Z | 58972.48 | 59080.67 | 57162.76 | 57293.29 | 16960.761333 | BTCUSDT |
;| 2024-09-03T00:00:00Z | 57293.29 | 59432.74 | 57124.21 | 59142.75 | 23098.259720 | BTCUSDT |
;| 2024-09-04T00:00:00Z | 59142.75 | 59825.00 | 57401.01 | 57481.78 | 20902.434172 | BTCUSDT |
;| 2024-09-05T00:00:00Z | 57481.78 | 58526.02 | 55566.05 | 57972.69 | 30443.293677 | BTCUSDT |
;| 2024-09-06T00:00:00Z | 57972.69 | 58333.08 | 55632.01 | 56177.67 | 28363.931568 | BTCUSDT |
;| 2024-09-07T00:00:00Z | 56177.67 | 57018.51 | 52535.50 | 53961.62 | 33299.004330 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 53961.62 | 54851.34 | 53750.02 | 54164.51 | 22779.134421 | BTCUSDT |

(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :m]
              :bardb :nippy}
             {}))

;=> _unnamed [54720 7]:
;
;|                :date |    :open |    :high |     :low |   :close |   :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|----------:|---------|
;| 2024-08-01T00:01:00Z | 64631.66 | 64681.04 | 64602.43 | 64634.26 | 22.534596 | BTCUSDT |
;| 2024-08-01T00:02:00Z | 64634.26 | 64691.09 | 64620.67 | 64671.30 | 13.958742 | BTCUSDT |
;| 2024-08-01T00:03:00Z | 64671.30 | 64703.44 | 64622.29 | 64623.85 | 13.145399 | BTCUSDT |
;| 2024-08-01T00:04:00Z | 64623.85 | 64700.55 | 64623.85 | 64687.91 | 16.006270 | BTCUSDT |
;| 2024-08-01T00:05:00Z | 64687.91 | 64710.94 | 64674.54 | 64679.51 | 11.166516 | BTCUSDT |
;| 2024-08-01T00:06:00Z | 64679.51 | 64744.75 | 64679.51 | 64744.75 |  8.044719 | BTCUSDT |
;| 2024-08-01T00:07:00Z | 64744.75 | 64780.50 | 64729.61 | 64780.49 |  8.742001 | BTCUSDT |
;| 2024-08-01T00:08:00Z | 64780.49 | 64794.80 | 64727.72 | 64735.00 | 17.130190 | BTCUSDT |
;| 2024-08-01T00:09:00Z | 64735.00 | 64761.00 | 64675.85 | 64723.95 | 16.429661 | BTCUSDT |
;| 2024-08-01T00:10:00Z | 64723.95 | 64788.93 | 64720.41 | 64786.35 | 13.307908 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |       ... |     ... |
;| 2024-09-07T23:50:00Z | 54107.04 | 54117.41 | 54099.73 | 54113.32 |  7.698892 | BTCUSDT |
;| 2024-09-07T23:51:00Z | 54113.32 | 54145.99 | 54094.94 | 54139.98 | 21.830693 | BTCUSDT |
;| 2024-09-07T23:52:00Z | 54139.98 | 54176.68 | 54139.98 | 54155.16 |  8.630863 | BTCUSDT |
;| 2024-09-07T23:53:00Z | 54155.16 | 54155.16 | 54129.34 | 54149.61 | 10.728079 | BTCUSDT |
;| 2024-09-07T23:54:00Z | 54149.61 | 54149.98 | 54107.00 | 54107.00 |  7.484142 | BTCUSDT |
;| 2024-09-07T23:55:00Z | 54107.00 | 54192.23 | 54104.00 | 54174.11 | 25.524945 | BTCUSDT |
;| 2024-09-07T23:56:00Z | 54174.11 | 54195.52 | 54165.77 | 54176.00 | 11.268023 | BTCUSDT |
;| 2024-09-07T23:57:00Z | 54176.00 | 54176.00 | 54146.79 | 54146.80 |  9.413673 | BTCUSDT |
;| 2024-09-07T23:58:00Z | 54146.80 | 54174.00 | 54146.79 | 54148.01 | 12.154609 | BTCUSDT |
;| 2024-09-07T23:59:00Z | 54148.01 | 54181.99 | 54145.14 | 54181.99 |  7.293840 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 54181.99 | 54181.99 | 54148.01 | 54164.51 | 14.264258 | BTCUSDT |

; full month available
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {:start (t/instant "2024-08-01T00:00:00Z")
              :end (t/instant "2024-09-01T00:00:00Z")}))
;=> _unnamed [31 7]:
;
;|                :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-08-02T00:00:00Z | 64631.66 | 65664.17 | 62276.07 | 65359.52 | 26649.072201 | BTCUSDT |
;| 2024-08-03T00:00:00Z | 65359.52 | 65604.69 | 61220.51 | 61492.70 | 30995.032601 | BTCUSDT |
;| 2024-08-04T00:00:00Z | 61492.70 | 62195.44 | 59845.00 | 60706.71 | 24048.623913 | BTCUSDT |
;| 2024-08-05T00:00:00Z | 60706.71 | 61117.99 | 57141.00 | 58165.87 | 22629.787445 | BTCUSDT |
;| 2024-08-06T00:00:00Z | 58165.87 | 58308.01 | 48974.00 | 54024.47 | 83370.985286 | BTCUSDT |
;| 2024-08-07T00:00:00Z | 54024.47 | 57078.28 | 53946.16 | 56019.93 | 29868.423264 | BTCUSDT |
;| 2024-08-08T00:00:00Z | 56019.93 | 57753.00 | 54548.70 | 55143.12 | 24187.586582 | BTCUSDT |
;| 2024-08-09T00:00:00Z | 55143.12 | 62745.45 | 54736.64 | 61686.97 | 26074.519089 | BTCUSDT |
;| 2024-08-10T00:00:00Z | 61686.97 | 61757.07 | 59520.53 | 60845.02 | 22877.550585 | BTCUSDT |
;| 2024-08-11T00:00:00Z | 60845.02 | 61484.99 | 60240.58 | 60923.71 | 22990.614685 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |          ... |     ... |
;| 2024-08-22T00:00:00Z | 59007.92 | 61829.56 | 58776.44 | 61152.67 | 25831.176681 | BTCUSDT |
;| 2024-08-23T00:00:00Z | 61152.67 | 61417.81 | 59700.00 | 60388.68 | 23357.894027 | BTCUSDT |
;| 2024-08-24T00:00:00Z | 60388.68 | 65000.00 | 60338.34 | 64046.30 | 26153.535146 | BTCUSDT |
;| 2024-08-25T00:00:00Z | 64046.30 | 64500.00 | 63543.28 | 64153.50 | 19546.945175 | BTCUSDT |
;| 2024-08-26T00:00:00Z | 64153.50 | 65032.12 | 63780.00 | 64218.10 | 18111.952814 | BTCUSDT |
;| 2024-08-27T00:00:00Z | 64218.10 | 64479.22 | 62796.41 | 62834.75 | 26594.582272 | BTCUSDT |
;| 2024-08-28T00:00:00Z | 62834.75 | 63213.07 | 57955.58 | 59411.08 | 33807.337927 | BTCUSDT |
;| 2024-08-29T00:00:00Z | 59411.08 | 60257.77 | 57801.54 | 59044.69 | 23996.944745 | BTCUSDT |
;| 2024-08-30T00:00:00Z | 59044.69 | 61175.07 | 58703.08 | 59348.57 | 18827.563337 | BTCUSDT |
;| 2024-08-31T00:00:00Z | 59348.57 | 59944.16 | 57700.00 | 59130.23 | 19456.016647 | BTCUSDT |
;| 2024-09-01T00:00:00Z | 59130.23 | 59463.00 | 58736.42 | 58972.48 |  7176.997611 | BTCUSDT |

; month with missing data
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy}
             {:start (t/instant "2024-09-01T00:00:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))
;=> _unnamed [8 7]:
;
;|                :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-09-01T00:00:00Z | 59130.23 | 59463.00 | 58736.42 | 58972.48 |  7176.997611 | BTCUSDT |
;| 2024-09-02T00:00:00Z | 58972.48 | 59080.67 | 57162.76 | 57293.29 | 16960.761333 | BTCUSDT |
;| 2024-09-03T00:00:00Z | 57293.29 | 59432.74 | 57124.21 | 59142.75 | 23098.259720 | BTCUSDT |
;| 2024-09-04T00:00:00Z | 59142.75 | 59825.00 | 57401.01 | 57481.78 | 20902.434172 | BTCUSDT |
;| 2024-09-05T00:00:00Z | 57481.78 | 58526.02 | 55566.05 | 57972.69 | 30443.293677 | BTCUSDT |
;| 2024-09-06T00:00:00Z | 57972.69 | 58333.08 | 55632.01 | 56177.67 | 28363.931568 | BTCUSDT |
;| 2024-09-07T00:00:00Z | 56177.67 | 57018.51 | 52535.50 | 53961.62 | 33299.004330 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 53961.62 | 54851.34 | 53750.02 | 54164.51 | 22779.134421 | BTCUSDT |


(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :m]
              :bardb :nippy}
             {:start (t/instant "2024-09-01T00:01:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))
;=> _unnamed [10080 7]:
;
;|                :date |    :open |    :high |     :low |   :close |   :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|----------:|---------|
;| 2024-09-01T00:01:00Z | 58972.48 | 58979.08 | 58964.05 | 58969.49 |  4.422219 | BTCUSDT |
;| 2024-09-01T00:02:00Z | 58969.49 | 58978.39 | 58958.55 | 58958.56 |  2.933589 | BTCUSDT |
;| 2024-09-01T00:03:00Z | 58958.56 | 58980.97 | 58958.55 | 58980.97 |  5.507146 | BTCUSDT |
;| 2024-09-01T00:04:00Z | 58980.97 | 58980.97 | 58959.92 | 58968.23 | 12.295103 | BTCUSDT |
;| 2024-09-01T00:05:00Z | 58968.23 | 58990.35 | 58968.23 | 58990.35 |  5.143927 | BTCUSDT |
;| 2024-09-01T00:06:00Z | 58990.35 | 58993.50 | 58976.85 | 58991.80 |  5.114475 | BTCUSDT |
;| 2024-09-01T00:07:00Z | 58991.80 | 58998.08 | 58990.41 | 58993.95 | 10.233298 | BTCUSDT |
;| 2024-09-01T00:08:00Z | 58993.95 | 59031.01 | 58993.51 | 59031.01 |  6.690333 | BTCUSDT |
;| 2024-09-01T00:09:00Z | 59031.01 | 59047.11 | 59027.11 | 59038.78 |  7.627480 | BTCUSDT |
;| 2024-09-01T00:10:00Z | 59038.78 | 59042.92 | 59033.81 | 59039.38 |  1.574641 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |       ... |     ... |
;| 2024-09-07T23:50:00Z | 54107.04 | 54117.41 | 54099.73 | 54113.32 |  7.698892 | BTCUSDT |
;| 2024-09-07T23:51:00Z | 54113.32 | 54145.99 | 54094.94 | 54139.98 | 21.830693 | BTCUSDT |
;| 2024-09-07T23:52:00Z | 54139.98 | 54176.68 | 54139.98 | 54155.16 |  8.630863 | BTCUSDT |
;| 2024-09-07T23:53:00Z | 54155.16 | 54155.16 | 54129.34 | 54149.61 | 10.728079 | BTCUSDT |
;| 2024-09-07T23:54:00Z | 54149.61 | 54149.98 | 54107.00 | 54107.00 |  7.484142 | BTCUSDT |
;| 2024-09-07T23:55:00Z | 54107.00 | 54192.23 | 54104.00 | 54174.11 | 25.524945 | BTCUSDT |
;| 2024-09-07T23:56:00Z | 54174.11 | 54195.52 | 54165.77 | 54176.00 | 11.268023 | BTCUSDT |
;| 2024-09-07T23:57:00Z | 54176.00 | 54176.00 | 54146.79 | 54146.80 |  9.413673 | BTCUSDT |
;| 2024-09-07T23:58:00Z | 54146.80 | 54174.00 | 54146.79 | 54148.01 | 12.154609 | BTCUSDT |
;| 2024-09-07T23:59:00Z | 54148.01 | 54181.99 | 54145.14 | 54181.99 |  7.293840 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 54181.99 | 54181.99 | 54148.01 | 54164.51 | 14.264258 | BTCUSDT |


; compress
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :h]
              :bardb :nippy
              :to :nippy
              :transform :compress}
             {:start (t/instant "2024-09-01T00:01:00Z")
              :end (t/instant "2024-10-01T00:00:00Z")}))

;=> _unnamed [168 7]:
;
;|                :date |    :open |    :high |     :low |   :close |     :volume | :count |
;|----------------------|---------:|---------:|---------:|---------:|------------:|-------:|
;| 2024-09-01T01:00:00Z | 58972.48 | 59080.67 | 58900.39 | 58937.19 |  423.351183 |     60 |
;| 2024-09-01T02:00:00Z | 58937.19 | 58961.49 | 58828.60 | 58830.78 |  526.494885 |     60 |
;| 2024-09-01T03:00:00Z | 58830.78 | 58874.48 | 58272.43 | 58544.37 | 1100.334691 |     60 |
;| 2024-09-01T04:00:00Z | 58544.37 | 58676.19 | 58405.11 | 58532.57 |  558.784013 |     60 |
;| 2024-09-01T05:00:00Z | 58532.57 | 58606.32 | 58362.62 | 58440.95 |  523.211722 |     60 |
;| 2024-09-01T06:00:00Z | 58440.95 | 58471.89 | 57766.92 | 57990.29 | 1244.488976 |     60 |
;| 2024-09-01T07:00:00Z | 57990.29 | 58303.88 | 57952.60 | 58197.94 |  662.237077 |     60 |
;| 2024-09-01T08:00:00Z | 58197.94 | 58503.07 | 58130.12 | 58486.20 |  803.564506 |     60 |
;| 2024-09-01T09:00:00Z | 58486.20 | 58513.10 | 58201.40 | 58244.93 |  492.750693 |     60 |
;| 2024-09-01T10:00:00Z | 58244.93 | 58405.50 | 58150.01 | 58205.00 |  558.399776 |     60 |
;|                  ... |      ... |      ... |      ... |      ... |         ... |    ... |
;| 2024-09-07T14:00:00Z | 54581.72 | 54663.59 | 54402.29 | 54550.33 | 1320.501881 |     60 |
;| 2024-09-07T15:00:00Z | 54550.33 | 54692.99 | 54484.02 | 54629.55 | 1143.348466 |     60 |
;| 2024-09-07T16:00:00Z | 54629.55 | 54834.99 | 54593.30 | 54780.01 | 1296.544156 |     60 |
;| 2024-09-07T17:00:00Z | 54780.01 | 54851.34 | 54438.31 | 54469.01 | 1070.184667 |     60 |
;| 2024-09-07T18:00:00Z | 54469.01 | 54543.99 | 53997.30 | 54134.13 | 1029.795276 |     60 |
;| 2024-09-07T19:00:00Z | 54134.13 | 54401.76 | 54037.34 | 54292.00 |  912.798262 |     60 |
;| 2024-09-07T20:00:00Z | 54292.00 | 54463.01 | 54230.19 | 54402.07 |  955.373131 |     60 |
;| 2024-09-07T21:00:00Z | 54402.07 | 54440.44 | 54160.06 | 54160.06 | 1079.201546 |     60 |
;| 2024-09-07T22:00:00Z | 54160.06 | 54193.95 | 53862.84 | 53928.09 |  633.419891 |     60 |
;| 2024-09-07T23:00:00Z | 53928.09 | 54090.68 | 53864.49 | 53958.50 |  543.640332 |     60 |
;| 2024-09-08T00:00:00Z | 53958.50 | 54215.23 | 53809.51 | 54164.51 |  640.556576 |     60 |


;; append-only
(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :d]
              :bardb :nippy
              :to :nippy
              :import :bybit-parallel
              :transform :append-only}
             {:start (t/instant "2024-08-25T00:00:00Z")
              :end (t/instant "2024-09-15T00:00:00Z")}))

;=> _unnamed [22 7]:
;
;|                :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-08-25T00:00:00Z | 64046.30 | 64500.00 | 63543.28 | 64153.50 | 19546.945175 | BTCUSDT |
;| 2024-08-26T00:00:00Z | 64153.50 | 65032.12 | 63780.00 | 64218.10 | 18111.952814 | BTCUSDT |
;| 2024-08-27T00:00:00Z | 64218.10 | 64479.22 | 62796.41 | 62834.75 | 26594.582272 | BTCUSDT |
;| 2024-08-28T00:00:00Z | 62834.75 | 63213.07 | 57955.58 | 59411.08 | 33807.337927 | BTCUSDT |
;| 2024-08-29T00:00:00Z | 59411.08 | 60257.77 | 57801.54 | 59044.69 | 23996.944745 | BTCUSDT |
;| 2024-08-30T00:00:00Z | 59044.69 | 61175.07 | 58703.08 | 59348.57 | 18827.563337 | BTCUSDT |
;| 2024-08-31T00:00:00Z | 59348.57 | 59944.16 | 57700.00 | 59130.23 | 19456.016647 | BTCUSDT |
;| 2024-09-01T00:00:00Z | 59130.23 | 59463.00 | 58736.42 | 58972.48 |  7176.997611 | BTCUSDT |
;| 2024-09-02T00:00:00Z | 58972.48 | 59080.67 | 57162.76 | 57293.29 | 16960.761333 | BTCUSDT |
;| 2024-09-03T00:00:00Z | 57293.29 | 59432.74 | 57124.21 | 59142.75 | 23098.259720 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |          ... |     ... |
;| 2024-09-05T00:00:00Z | 57481.78 | 58526.02 | 55566.05 | 57972.69 | 30443.293677 | BTCUSDT |
;| 2024-09-06T00:00:00Z | 57972.69 | 58333.08 | 55632.01 | 56177.67 | 28363.931568 | BTCUSDT |
;| 2024-09-07T00:00:00Z | 56177.67 | 57018.51 | 52535.50 | 53961.62 | 33299.004330 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 53961.62 | 54851.34 | 53750.02 | 54164.51 | 22779.134421 | BTCUSDT |
;| 2024-09-09T00:00:00Z | 54164.51 | 55324.49 | 53628.06 | 54877.92 | 14830.880938 | BTCUSDT |
;| 2024-09-10T00:00:00Z | 54877.92 | 58130.24 | 54591.47 | 57039.58 | 21486.315072 | BTCUSDT |
;| 2024-09-11T00:00:00Z | 57039.58 | 58052.21 | 56383.76 | 57643.48 | 25482.208587 | BTCUSDT |
;| 2024-09-12T00:00:00Z | 57643.48 | 57991.00 | 55555.00 | 57334.15 | 26867.906044 | BTCUSDT |
;| 2024-09-13T00:00:00Z | 57334.15 | 58582.80 | 57318.13 | 58134.02 | 24532.880423 | BTCUSDT |
;| 2024-09-14T00:00:00Z | 58134.02 | 60628.71 | 57627.44 | 60486.46 | 27348.341105 | BTCUSDT |
;| 2024-09-15T00:00:00Z | 60486.46 | 60605.59 | 59381.96 | 59993.99 | 10879.880909 | BTCUSDT |

; new data available:
(m/?
  (b/get-bars bar-engine
              {:asset "BTCUSDT"
               :calendar [:crypto :d]
               :bardb :nippy}
              {}))

;=> _unnamed [45 7]:
;
;|                :date |    :open |    :high |     :low |   :close |      :volume |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|-------------:|---------|
;| 2024-08-02T00:00:00Z | 64631.66 | 65664.17 | 62276.07 | 65359.52 | 26649.072201 | BTCUSDT |
;| 2024-08-03T00:00:00Z | 65359.52 | 65604.69 | 61220.51 | 61492.70 | 30995.032601 | BTCUSDT |
;| 2024-08-04T00:00:00Z | 61492.70 | 62195.44 | 59845.00 | 60706.71 | 24048.623913 | BTCUSDT |
;| 2024-08-05T00:00:00Z | 60706.71 | 61117.99 | 57141.00 | 58165.87 | 22629.787445 | BTCUSDT |
;| 2024-08-06T00:00:00Z | 58165.87 | 58308.01 | 48974.00 | 54024.47 | 83370.985286 | BTCUSDT |
;| 2024-08-07T00:00:00Z | 54024.47 | 57078.28 | 53946.16 | 56019.93 | 29868.423264 | BTCUSDT |
;| 2024-08-08T00:00:00Z | 56019.93 | 57753.00 | 54548.70 | 55143.12 | 24187.586582 | BTCUSDT |
;| 2024-08-09T00:00:00Z | 55143.12 | 62745.45 | 54736.64 | 61686.97 | 26074.519089 | BTCUSDT |
;| 2024-08-10T00:00:00Z | 61686.97 | 61757.07 | 59520.53 | 60845.02 | 22877.550585 | BTCUSDT |
;| 2024-08-11T00:00:00Z | 60845.02 | 61484.99 | 60240.58 | 60923.71 | 22990.614685 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |          ... |     ... |
;| 2024-09-05T00:00:00Z | 57481.78 | 58526.02 | 55566.05 | 57972.69 | 30443.293677 | BTCUSDT |
;| 2024-09-06T00:00:00Z | 57972.69 | 58333.08 | 55632.01 | 56177.67 | 28363.931568 | BTCUSDT |
;| 2024-09-07T00:00:00Z | 56177.67 | 57018.51 | 52535.50 | 53961.62 | 33299.004330 | BTCUSDT |
;| 2024-09-08T00:00:00Z | 53961.62 | 54851.34 | 53750.02 | 54164.51 | 22779.134421 | BTCUSDT |
;| 2024-09-09T00:00:00Z | 54164.51 | 55324.49 | 53628.06 | 54877.92 | 14830.880938 | BTCUSDT |
;| 2024-09-10T00:00:00Z | 54877.92 | 58130.24 | 54591.47 | 57039.58 | 21486.315072 | BTCUSDT |
;| 2024-09-11T00:00:00Z | 57039.58 | 58052.21 | 56383.76 | 57643.48 | 25482.208587 | BTCUSDT |
;| 2024-09-12T00:00:00Z | 57643.48 | 57991.00 | 55555.00 | 57334.15 | 26867.906044 | BTCUSDT |
;| 2024-09-13T00:00:00Z | 57334.15 | 58582.80 | 57318.13 | 58134.02 | 24532.880423 | BTCUSDT |
;| 2024-09-14T00:00:00Z | 58134.02 | 60628.71 | 57627.44 | 60486.46 | 27348.341105 | BTCUSDT |
;| 2024-09-15T00:00:00Z | 60486.46 | 60605.59 | 59381.96 | 59993.99 | 10879.880909 | BTCUSDT |


(m/?
 (b/get-bars bar-engine
             {:asset "BTCUSDT"
              :calendar [:crypto :h]
              :bardb :nippy
              :to :nippy
              :import :bybit-parallel
              :transform :append-only}
             {:start (t/instant "2024-09-05T00:00:00Z")
              :end (t/instant "2024-09-12T00:00:00Z")}))

;=> _unnamed [169 8]:
;
;|                :date |    :open |    :high |     :low |   :close |     :volume | :count |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|------------:|-------:|---------|
;| 2024-09-05T00:00:00Z | 58133.76 | 58238.09 | 57887.42 | 57972.69 |  966.186120 |     60 | BTCUSDT |
;| 2024-09-05T01:00:00Z | 57972.69 | 58333.08 | 57953.52 | 58006.90 | 1062.776013 |     60 | BTCUSDT |
;| 2024-09-05T02:00:00Z | 58006.90 | 58250.67 | 57952.61 | 58025.10 |  936.699271 |     60 | BTCUSDT |
;| 2024-09-05T03:00:00Z | 58025.10 | 58068.69 | 57641.42 | 57693.34 |  970.992951 |     60 | BTCUSDT |
;| 2024-09-05T04:00:00Z | 57693.34 | 57696.47 | 56912.01 | 57130.84 | 1594.769806 |     60 | BTCUSDT |
;| 2024-09-05T05:00:00Z | 57130.84 | 57292.15 | 57069.10 | 57212.34 |  983.860398 |     60 | BTCUSDT |
;| 2024-09-05T06:00:00Z | 57212.34 | 57264.09 | 57025.36 | 57195.20 | 1029.235995 |     60 | BTCUSDT |
;| 2024-09-05T07:00:00Z | 57195.20 | 57229.99 | 56537.77 | 56910.26 | 1388.620937 |     60 | BTCUSDT |
;| 2024-09-05T08:00:00Z | 56910.26 | 57246.32 | 56827.60 | 57153.66 | 1101.803440 |     60 | BTCUSDT |
;| 2024-09-05T09:00:00Z | 57153.66 | 57233.44 | 56950.73 | 57012.85 | 1009.903951 |     60 | BTCUSDT |
;|                  ... |      ... |      ... |      ... |      ... |         ... |    ... |     ... |
;| 2024-09-11T14:00:00Z | 56742.50 | 57171.94 | 55709.60 | 55737.67 | 1769.451559 |     60 | BTCUSDT |
;| 2024-09-11T15:00:00Z | 55737.67 | 56029.82 | 55555.00 | 55973.42 | 1441.854310 |     60 | BTCUSDT |
;| 2024-09-11T16:00:00Z | 55973.42 | 57018.37 | 55851.20 | 56700.22 | 1294.142788 |     60 | BTCUSDT |
;| 2024-09-11T17:00:00Z | 56700.22 | 57536.09 | 56649.50 | 57312.77 | 1131.225724 |     60 | BTCUSDT |
;| 2024-09-11T18:00:00Z | 57312.77 | 57883.39 | 57250.95 | 57698.84 | 1026.714836 |     60 | BTCUSDT |
;| 2024-09-11T19:00:00Z | 57698.84 | 57991.00 | 57380.00 | 57499.83 | 1213.169462 |     60 | BTCUSDT |
;| 2024-09-11T20:00:00Z | 57499.83 | 57782.85 | 57324.32 | 57584.78 |  789.042178 |     60 | BTCUSDT |
;| 2024-09-11T21:00:00Z | 57584.78 | 57682.39 | 57433.07 | 57479.41 |  665.055058 |     60 | BTCUSDT |
;| 2024-09-11T22:00:00Z | 57479.41 | 57559.54 | 57250.01 | 57358.33 |  449.620924 |     60 | BTCUSDT |
;| 2024-09-11T23:00:00Z | 57358.33 | 57472.98 | 57208.66 | 57471.56 |  739.665440 |     60 | BTCUSDT |
;| 2024-09-12T00:00:00Z | 57471.56 | 57516.64 | 57303.25 | 57334.15 |  685.495232 |     60 | BTCUSDT |

; new data
(m/?
  (b/get-bars bar-engine
              {:asset "BTCUSDT"
               :calendar [:crypto :m]
               :bardb :nippy}
              {}))

(m/?
  (b/get-bars bar-engine
              {:asset "BTCUSDT"
               :calendar [:crypto :m5]
               :bardb :nippy
               :to :nippy
               :import :bybit-parallel
               :transform :append-only}
              {:start (t/instant "2024-09-07T23:57:00Z")
               :end (t/instant "2024-09-08T01:14:00Z")}))
;=> _unnamed [14 8]:
;
;|                :date |    :open |    :high |     :low |   :close |   :volume | :count |  :asset |
;|----------------------|---------:|---------:|---------:|---------:|----------:|-------:|---------|
;| 2024-09-01T00:05:00Z | 58972.48 | 58990.35 | 58958.55 | 58990.35 | 30.301984 |      5 | BTCUSDT |
;| 2024-09-01T00:10:00Z | 58990.35 | 59047.11 | 58976.85 | 59039.38 | 31.240227 |      5 | BTCUSDT |
;| 2024-09-01T00:15:00Z | 59039.38 | 59062.28 | 59023.92 | 59043.51 | 30.613704 |      5 | BTCUSDT |
;| 2024-09-01T00:20:00Z | 59043.51 | 59080.67 | 59020.72 | 59020.72 | 47.219707 |      5 | BTCUSDT |
;| 2024-09-01T00:25:00Z | 59020.72 | 59026.99 | 58988.71 | 58990.32 | 26.600584 |      5 | BTCUSDT |
;| 2024-09-01T00:30:00Z | 58990.32 | 58991.89 | 58914.31 | 58965.05 | 36.351173 |      5 | BTCUSDT |
;| 2024-09-01T00:35:00Z | 58965.05 | 58965.05 | 58916.08 | 58959.90 | 43.246325 |      5 | BTCUSDT |
;| 2024-09-01T00:40:00Z | 58959.90 | 59004.70 | 58959.90 | 58985.87 | 25.046366 |      5 | BTCUSDT |
;| 2024-09-01T00:45:00Z | 58985.87 | 59025.48 | 58900.39 | 58913.70 | 28.773386 |      5 | BTCUSDT |
;| 2024-09-01T00:50:00Z | 58913.70 | 58959.88 | 58913.70 | 58933.18 | 41.243072 |      5 | BTCUSDT |
;| 2024-09-01T00:55:00Z | 58933.18 | 58974.28 | 58932.72 | 58966.28 | 38.663232 |      5 | BTCUSDT |
;| 2024-09-01T01:00:00Z | 58966.28 | 58982.95 | 58933.90 | 58937.19 | 44.051423 |      5 | BTCUSDT |
;| 2024-09-01T01:05:00Z | 58937.19 | 58947.09 | 58910.17 | 58927.49 | 23.932046 |      5 | BTCUSDT |
;| 2024-09-01T01:10:00Z | 58927.49 | 58945.43 | 58904.44 | 58927.94 | 29.942140 |      5 | BTCUSDT |
