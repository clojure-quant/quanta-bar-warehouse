(ns dev.split.single
  (:require
   [tick.core :as t]
   [tablecloth.api :as tc]
   [quanta.bar.split.adjust :refer [add-split-factor-linear split-adjust]]))

(def bars
  (tc/dataset {:date [(t/date "1999-01-01")
                      (t/date "2000-01-01")
                      (t/date "2000-01-02")
                      (t/date "2000-04-01")
                      (t/date "2000-04-02")
                      (t/date "2000-04-20")
                      (t/date "2000-04-21")
                      (t/date "2000-04-22")
                      (t/date "2000-05-04")
                      (t/date "2000-05-05")
                      (t/date "2000-05-07")]
               :open [1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0]
               :high [1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0]
               :low [1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0]
               :close [1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0]
               :volume [1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0 1.0]}))

(def splits
  (tc/dataset {:date [(t/date "2000-01-02")
                      (t/date "2000-04-20")
                      (t/date "2000-04-21")]
               :factor [2.0 2.0 1.5]}))

(-> (add-split-factor-linear bars splits)
    (tc/select-columns [:date :factor]))

;|      :date | :factor |
;|------------|--------:|
;| 1999-01-01 |     6.0 |
;| 2000-01-01 |     6.0 |
;| 2000-01-02 |     6.0 |
;| 2000-04-01 |     3.0 |
;| 2000-04-02 |     3.0 |
;| 2000-04-20 |     3.0 |
;| 2000-04-21 |     1.5 |
;| 2000-04-22 |     1.0 |
;| 2000-05-04 |     1.0 |
;| 2000-05-05 |     1.0 |
;| 2000-05-07 |     1.0 |

(split-adjust bars splits)

;|      :date | :open | :high | :low | :close |    :volume | :factor |
;|------------|------:|------:|-----:|-------:|-----------:|--------:|
;| 1999-01-01 |   6.0 |   6.0 |  6.0 |    6.0 | 0.16666667 |     6.0 |
;| 2000-01-01 |   6.0 |   6.0 |  6.0 |    6.0 | 0.16666667 |     6.0 |
;| 2000-01-02 |   6.0 |   6.0 |  6.0 |    6.0 | 0.16666667 |     6.0 |
;| 2000-04-01 |   3.0 |   3.0 |  3.0 |    3.0 | 0.33333333 |     3.0 |
;| 2000-04-02 |   3.0 |   3.0 |  3.0 |    3.0 | 0.33333333 |     3.0 |
;| 2000-04-20 |   3.0 |   3.0 |  3.0 |    3.0 | 0.33333333 |     3.0 |
;| 2000-04-21 |   1.5 |   1.5 |  1.5 |    1.5 | 0.66666667 |     1.5 |
;| 2000-04-22 |   1.0 |   1.0 |  1.0 |    1.0 | 1.00000000 |     1.0 |
;| 2000-05-04 |   1.0 |   1.0 |  1.0 |    1.0 | 1.00000000 |     1.0 |
;| 2000-05-05 |   1.0 |   1.0 |  1.0 |    1.0 | 1.00000000 |     1.0 |
;| 2000-05-07 |   1.0 |   1.0 |  1.0 |    1.0 | 1.00000000 |     1.0 |