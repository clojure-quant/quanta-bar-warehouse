(ns dev.barimport-test
  (:require 
    [tick.core :as t]
    [ta.calendar.core :refer [trailing-range]]
    [ta.db.bars.protocol :as b]
    [dev.env :refer [bar-engine]]))


(def dt (-> (t/instant)
            (t/<< (t/new-duration 2 :days))
            ))

dt
;; => #time/instant "2024-10-08T23:12:45.290640436Z"


(trailing-range [:us :d] 3  dt)
;; => {:end #time/zoned-date-time "2024-10-08T17:00-04:00[America/New_York]",
;;     :start #time/zoned-date-time "2024-10-04T17:00-04:00[America/New_York]"}

(def w
  (trailing-range [:us :d] 3  dt)
  )


(b/get-bars bar-engine {:asset "AEE.AU"
                :calendar [:us :d]
                :import :eodhd}
            w)
;; => _unnamed [3 7]:
;;    
;;    |                :date | :open | :high |  :low | :close | :adjusted_close | :volume |
;;    |----------------------|------:|------:|------:|-------:|----------------:|--------:|
;;    | 2024-10-04T00:00:00Z | 0.160 | 0.165 | 0.155 |  0.155 |           0.155 |  808354 |
;;    | 2024-10-07T00:00:00Z | 0.160 | 0.160 | 0.155 |  0.155 |           0.155 |  684094 |
;;    | 2024-10-08T00:00:00Z | 0.155 | 0.160 | 0.145 |  0.155 |           0.155 | 1462155 |

(b/get-bars bar-engine {:asset "QQQ"
                        :calendar [:us :d]
                        :import :alphavantage}
            w)
;; => Execution error (ClassCastException) at cljc.java-time.local-date-time/is-before (local_date_time.clj:31).
;;    class java.time.ZonedDateTime cannot be cast to class java.time.chrono.ChronoLocalDateTime (java.time.ZonedDateTime and java.time.chrono.ChronoLocalDateTime are in module java.base of loader 'bootstrap')


(b/get-bars bar-engine {:asset "BTCUSDT"
                        :calendar [:us :d]
                        :import :bybit}
            w)
;; => _unnamed [5 6]:
;;    
;;    |                :date |    :open |    :high |     :low |   :close |      :volume |
;;    |----------------------|---------:|---------:|---------:|---------:|-------------:|
;;    | 2024-10-03T23:59:59Z | 60756.13 | 62486.35 | 60458.93 | 62090.14 | 23662.217058 |
;;    | 2024-10-04T23:59:59Z | 62090.14 | 62382.03 | 61680.63 | 62059.37 |  8936.861444 |
;;    | 2024-10-05T23:59:59Z | 62059.37 | 62983.78 | 61814.96 | 62824.80 |  9037.917928 |
;;    | 2024-10-06T23:59:59Z | 62824.80 | 64470.19 | 62115.15 | 62218.75 | 19762.195435 |
;;    | 2024-10-07T23:59:59Z | 62218.75 | 63202.67 | 61857.13 | 62156.22 | 20361.789732 |


(b/get-bars bar-engine
            {:asset "EUR/USD" ; forex
             :calendar [:forex :d]
             :import :kibot}
            {:start (t/instant "2023-01-01T00:00:00Z")
             :end (t/instant "2024-05-01T00:00:00Z")})
;; => kibot-bars [347 6]:
;;    
;;    |                                    :date |   :open |   :high |    :low |  :close | :volume |
;;    |------------------------------------------|--------:|--------:|--------:|--------:|--------:|
;;    | 2023-01-02T16:30-05:00[America/New_York] | 1.06934 | 1.06993 | 1.06495 | 1.06647 |   50193 |
;;    | 2023-01-03T16:30-05:00[America/New_York] | 1.06647 | 1.06831 | 1.05194 | 1.05467 |  384972 |
;;    | 2023-01-04T16:30-05:00[America/New_York] | 1.05467 | 1.06351 | 1.05403 | 1.06019 |  384883 |
;;    | 2023-01-05T16:30-05:00[America/New_York] | 1.06019 | 1.06314 | 1.05149 | 1.05214 |  346821 |
;;    | 2023-01-06T16:30-05:00[America/New_York] | 1.05220 | 1.06480 | 1.04819 | 1.06392 |  349442 |
;;    | 2023-01-09T16:30-05:00[America/New_York] | 1.06410 | 1.07606 | 1.06365 | 1.07278 |  355470 |
;;    | 2023-01-10T16:30-05:00[America/New_York] | 1.07276 | 1.07594 | 1.07119 | 1.07329 |  346555 |
;;    | 2023-01-11T16:30-05:00[America/New_York] | 1.07328 | 1.07763 | 1.07254 | 1.07567 |  281839 |
;;    | 2023-01-12T16:30-05:00[America/New_York] | 1.07567 | 1.08670 | 1.07268 | 1.08522 |  481670 |
;;    | 2023-01-13T16:30-05:00[America/New_York] | 1.08525 | 1.08678 | 1.07803 | 1.08318 |  340880 |
;;    |                                      ... |     ... |     ... |     ... |     ... |     ... |
;;    | 2024-04-16T16:30-04:00[America/New_York] | 1.06241 | 1.06536 | 1.06011 | 1.06186 |  247391 |
;;    | 2024-04-17T16:30-04:00[America/New_York] | 1.06185 | 1.06795 | 1.06059 | 1.06727 |  209314 |
;;    | 2024-04-18T16:30-04:00[America/New_York] | 1.06726 | 1.06900 | 1.06413 | 1.06432 |  177121 |
;;    | 2024-04-19T16:30-04:00[America/New_York] | 1.06432 | 1.06776 | 1.06104 | 1.06521 |  263202 |
;;    | 2024-04-22T16:30-04:00[America/New_York] | 1.06530 | 1.06707 | 1.06239 | 1.06539 |  146480 |
;;    | 2024-04-23T16:30-04:00[America/New_York] | 1.06532 | 1.07113 | 1.06385 | 1.07011 |  168084 |
;;    | 2024-04-24T16:30-04:00[America/New_York] | 1.07008 | 1.07142 | 1.06780 | 1.06987 |  140013 |
;;    | 2024-04-25T16:30-04:00[America/New_York] | 1.06987 | 1.07404 | 1.06782 | 1.07298 |  179636 |
;;    | 2024-04-26T16:30-04:00[America/New_York] | 1.07292 | 1.07528 | 1.06739 | 1.06912 |  174307 |
;;    | 2024-04-29T16:30-04:00[America/New_York] | 1.06909 | 1.07337 | 1.06901 | 1.07208 |  211949 |
;;    | 2024-04-30T16:30-04:00[America/New_York] | 1.07198 | 1.07354 | 1.06646 | 1.06654 |  200125 |



(b/get-bars bar-engine
            {:asset "QQQ" 
             :calendar [:us :d]
             :import :eodhd}
            {:start (t/instant "2024-09-21T00:00:00Z")
             :end (t/instant "2024-10-01T00:00:00Z")})
;; => _unnamed [7 7]:
;;    |                :date |  :open |  :high |   :low | :close | :adjusted_close |  :volume |
;;    |----------------------|-------:|-------:|-------:|-------:|----------------:|---------:|
;;    | 2024-09-20T00:00:00Z | 482.49 | 483.69 | 478.30 | 482.44 |        481.7631 | 34577660 |
;;    | 2024-09-23T00:00:00Z | 482.95 | 484.14 | 481.60 | 483.04 |        483.0400 | 24842971 |
;;    | 2024-09-24T00:00:00Z | 484.46 | 486.33 | 480.17 | 485.37 |        485.3700 | 25952641 |
;;    | 2024-09-25T00:00:00Z | 484.74 | 487.79 | 484.56 | 485.82 |        485.8200 | 26549900 |
;;    | 2024-09-26T00:00:00Z | 493.37 | 493.70 | 485.80 | 489.47 |        489.4700 | 32020200 |
;;    | 2024-09-27T00:00:00Z | 490.50 | 490.64 | 485.56 | 486.75 |        486.7500 | 22851100 |
;;    | 2024-09-30T00:00:00Z | 485.78 | 488.41 | 482.92 | 488.07 |        488.0700 | 30281100 |




(def window-daily
  (trailing-range [:us :d] 2  dt)
  
  )